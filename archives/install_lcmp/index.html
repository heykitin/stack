<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='放弃 LNMP 一键包和 Oneinstack 手动安装及配置 LCMP 环境'><title>Debian 下手动安装 LCMP 环境</title>
<link rel=canonical href=/archives/install_lcmp/><link rel=stylesheet href=/scss/style.min.c8018cc12b995319036e5d3fc6c9d7c580710d33387305a6c3e46b19200da795.css><meta property='og:title' content='Debian 下手动安装 LCMP 环境'><meta property='og:description' content='放弃 LNMP 一键包和 Oneinstack 手动安装及配置 LCMP 环境'><meta property='og:url' content='/archives/install_lcmp/'><meta property='og:site_name' content="Kitin's"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Linux'><meta property='article:tag' content='Caddy'><meta property='article:tag' content='MariaDB'><meta property='article:tag' content='PHP'><meta property='article:tag' content='Web'><meta property='article:published_time' content='2023-10-20T22:24:35+08:00'><meta property='article:modified_time' content='2023-10-20T22:24:35+08:00'><meta name=twitter:title content="Debian 下手动安装 LCMP 环境"><meta name=twitter:description content="放弃 LNMP 一键包和 Oneinstack 手动安装及配置 LCMP 环境"><link rel="shortcut icon" href=/favicon.ico><style>:root{--sys-font-family:"Noto Serif SC",;--zh-font-family:"Noto Serif SC";--base-font-family:"Noto Serif SC";--code-font-family:"Consolas";--article-font-family:"Noto Serif SC"}</style><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu3062918ec655b699aef6c10c56bc778d_207173_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Kitin's</a></h1><h2 class=site-description></h2></div></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#前言>前言</a><ol><li><a href=#脚本推荐>脚本推荐</a><ol><li><a href=#lamp-一键包>LAMP 一键包</a></li><li><a href=#lcmp-一键包>LCMP 一键包</a></li></ol></li></ol></li><li><a href=#安装与配置>安装与配置</a><ol><li><a href=#安装必要软件和依赖>安装必要软件和依赖</a></li><li><a href=#安装-caddy>安装 Caddy</a><ol><li><a href=#配置-caddy>配置 Caddy</a></li></ol></li><li><a href=#安装-mariadb>安装 MariaDB</a><ol><li><a href=#安装前的准备>安装前的准备</a></li><li><a href=#二进制安装>二进制安装</a></li><li><a href=#配置-mariadb>配置 MariaDB</a></li></ol></li><li><a href=#安装-php>安装 PHP</a><ol><li><a href=#准备工作>准备工作</a></li><li><a href=#源码编译安装>源码编译安装</a></li></ol></li><li><a href=#安装php-扩展>安装PHP 扩展</a><ol><li><a href=#redis-扩展>Redis 扩展</a></li><li><a href=#memcached-扩展>Memcached 扩展</a></li><li><a href=#imagick-扩展>Imagick 扩展</a></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/archives/install_lcmp/>Debian 下手动安装 LCMP 环境</a></h2><h3 class=article-subtitle>放弃 LNMP 一键包和 Oneinstack 手动安装及配置 LCMP 环境</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Oct 20, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 6 分钟</time></div></footer></div></header><section class=article-content><h2 id=前言>前言</h2><p>继 <a class=link href=https://mp.weixin.qq.com/s/OT7C1l5rjBNCawFXRIUJOQ target=_blank rel=noopener>LNMP 供应链投毒事件
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>后，知名 LNMP 部署工具 Oneinstack 也被发现挂码，参考 Oneinstack 项目 <a class=link href=https://github.com/oneinstack/oneinstack/issues/487 target=_blank rel=noopener>Issues #487
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>和 <a class=link href=https://github.com/oneinstack/oneinstack/issues/511 target=_blank rel=noopener>Issues #511
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p><p>此事在 Github 和 V2EX 上已有帖子在讨论；而始作俑者 <strong>金华市矜贵网络科技有限公司</strong> 至今陆续拥有了 <strong>WDCP</strong>、<strong>LNMP 一建包</strong> 和 <strong>Oneinstack</strong>；鉴于金华矜贵还试图收购秋水逸冰大佬的 <strong>LAMP 一键安装包</strong> (但被秋大拒绝了)，他们后续可能还会盯上其他部署工具；所以建议大家最近有使用过上述工具的直接重装系统。</p><p>而对 LNMP 一建包和 Oneinstack 有使用需求的人不在少数，所以我们必须寻找替代品，如上文提到的秋水逸冰大佬的 LAMP/LCMP 一键包或者学着自己进行搭建与配置。</p><hr><h3 id=脚本推荐>脚本推荐</h3><h4 id=lamp-一键包>LAMP 一键包</h4><p>LAMP 一键安装包是一个用 Linux Shell 编写的可以为 Amazon Linux 2/CentOS/Debian/Ubuntu 系统的 VPS 或服务器安装 LAMP(Linux + Apache + MySQL/MariaDB + PHP) 生产环境的 Shell 脚本。</p><ul><li><a class=link href=https://lamp.sh target=_blank rel=noopener>LAMP 一键包官网
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></li><li><a class=link href=https://github.com/teddysun/lamp target=_blank rel=noopener>Github 项目地址
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></li></ul><h4 id=lcmp-一键包>LCMP 一键包</h4><p>LCMP 一键包 (Linux + Caddy2 + MySQL/MariaDB + PHP) 是一个强大的 Bash 脚本，用于安装 Caddy2 + MariaDB + PHP；可以通过 <code>yum</code> 或 <code>apt-get</code> 命令在内存较小的 VPS 中安装 Caddy2 + MariaDB + PHP，只需在安装前输入数字选择要安装的内容即可；同为秋水逸冰大佬制作</p><ul><li><a class=link href=https://github.com/teddysun/lamp target=_blank rel=noopener>Github 项目地址
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></li></ul><p>接下来看下如何手动安装及配置。</p><hr><h2 id=安装与配置>安装与配置</h2><h3 id=安装必要软件和依赖>安装必要软件和依赖</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt update
</span></span><span class=line><span class=cl>apt install -y debian-keyring debian-archive-keyring build-essential gcc g++ make cmake autoconf libjpeg62-turbo-dev libjpeg-dev libpng-dev libwebp7 libwebp-dev libfreetype6 libfreetype6-dev libssh2-1-dev libmhash2 libpcre3 libpcre3-dev gzip libbz2-1.0 libbz2-dev libgd-dev libxml2 libxml2-dev libsodium-dev argon2 libargon2-1 libargon2-dev libiconv-hook-dev zlib1g zlib1g-dev libc6 libc6-dev libc-client2007e-dev libglib2.0-0 libglib2.0-dev bzip2 libzip-dev libbz2-1.0 libncurses5 libncurses5-dev libaio1 libaio-dev numactl libreadline-dev curl libcurl3-gnutls libcurl4-openssl-dev e2fsprogs libkrb5-3 libkrb5-dev libltdl-dev libidn11-dev openssl net-tools libssl-dev libtool libevent-dev bison re2c libsasl2-dev libxslt1-dev libicu-dev locales patch vim zip unzip tmux htop bc dc expect libexpat1-dev libonig-dev libtirpc-dev rsync git lsof lrzsz rsyslog cron logrotate chrony libsqlite3-dev psmisc wget sysv-rc apt-transport-https ca-certificates software-properties-common gnupg screen
</span></span></code></pre></div><h3 id=安装-caddy>安装 Caddy</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt install -y debian-keyring debian-archive-keyring apt-transport-https curl
</span></span><span class=line><span class=cl>curl -1sLf <span class=s1>&#39;https://dl.cloudsmith.io/public/caddy/stable/gpg.key&#39;</span> <span class=p>|</span> gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
</span></span><span class=line><span class=cl>curl -1sLf <span class=s1>&#39;https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt&#39;</span> <span class=p>|</span> tee /etc/apt/sources.list.d/caddy-stable.list
</span></span><span class=line><span class=cl>apt update
</span></span><span class=line><span class=cl>apt install caddy
</span></span></code></pre></div><h4 id=配置-caddy>配置 Caddy</h4><p>首先为 Caddy 创建网站目录和 SSL 存放目录，网站目录我设置为 <strong>/data/www</strong>，自有证书存放目录在 Caddy 默认位置中创建一个文件夹，位置可以自己更改</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p /data/www/default
</span></span><span class=line><span class=cl>mkdir -p /var/lib/caddy/ssl
</span></span></code></pre></div><p>将 Caddy 默认网站文件移到创建的默认网站文件夹中</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mv /usr/share/caddy/index.html /data/www/default
</span></span><span class=line><span class=cl>rm -r /usr/share/caddy
</span></span></code></pre></div><p>编辑 Caddyfile 配置文件，并进行重写，位于 <strong>/etc/caddy/Caddyfile</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; /etc/caddy/Caddyfile <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>:80 {
</span></span></span><span class=line><span class=cl><span class=s>	root * /data/www/default
</span></span></span><span class=line><span class=cl><span class=s>	header {
</span></span></span><span class=line><span class=cl><span class=s>		Strict-Transport-Security max-age=31536000;preload
</span></span></span><span class=line><span class=cl><span class=s>		X-Content-Type-Options nosniff
</span></span></span><span class=line><span class=cl><span class=s>		X-Frame-Options SAMEORIGIN
</span></span></span><span class=line><span class=cl><span class=s>	}
</span></span></span><span class=line><span class=cl><span class=s>	encode gzip
</span></span></span><span class=line><span class=cl><span class=s>	php_fastcgi unix//dev/shm/php-cgi.sock
</span></span></span><span class=line><span class=cl><span class=s>	file_server
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>caddy fmt --overwrite /etc/caddy/Caddyfile
</span></span></code></pre></div><hr><h3 id=安装-mariadb>安装 MariaDB</h3><p>可以使用预编译的二进制包安装或者源码编译进行安装，自行选择即可；我推荐使用二进制包进行安装。</p><h4 id=安装前的准备>安装前的准备</h4><p>为 MariaDB 创建用户组，创建安装目录并设置权限</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>useradd -M -s /sbin/nologin mysql
</span></span><span class=line><span class=cl>mkdir -p /usr/local/mariadb
</span></span><span class=line><span class=cl>mkdir -p /data/mariadb
</span></span><span class=line><span class=cl>chown -R mysql:mysql /usr/local/mariadb
</span></span><span class=line><span class=cl>chown -R mysql:mysql /data/mariadb
</span></span></code></pre></div><p>编译安装 Jemalloc 为 MariaDB 提供内存分配管理</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /usr/local/src
</span></span><span class=line><span class=cl>wget https://github.com/jemalloc/jemalloc/archive/5.3.0.tar.gz
</span></span><span class=line><span class=cl>tar zxf 5.3.0.tar.gz
</span></span><span class=line><span class=cl><span class=nb>cd</span> jemalloc-5.3.0
</span></span><span class=line><span class=cl>autoconf
</span></span><span class=line><span class=cl>./configure
</span></span><span class=line><span class=cl>make -j<span class=k>$(</span>nproc<span class=k>)</span>
</span></span><span class=line><span class=cl>make install
</span></span></code></pre></div><p>链接动态库</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ln -s /usr/local/lib/libjemalloc.so.2 /usr/lib/libjemalloc.so.1
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;/usr/local/lib&#39;</span> &gt; /etc/ld.so.conf.d/jemalloc.conf
</span></span><span class=line><span class=cl>ldconfig
</span></span></code></pre></div><h4 id=二进制安装>二进制安装</h4><p>下载二进制包</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /usr/local/src
</span></span><span class=line><span class=cl>wget https://archive.mariadb.org/mariadb-10.11.7/bintar-linux-systemd-x86_64/mariadb-10.11.7-linux-systemd-x86_64.tar.gz
</span></span></code></pre></div><p>国内主机可以使用清华源地址：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>https://mirrors.tuna.tsinghua.edu.cn/mariadb/mariadb-10.11.7/bintar-linux-systemd-x86_64/mariadb-10.11.7-linux-systemd-x86_64.tar.gz
</span></span></code></pre></div><p>只需要将下载好的预编译二进制文件解压到安装位置，然后更改相关文件的配置即可</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /usr/local/src
</span></span><span class=line><span class=cl>tar zxf mariadb-10.11.7-linux-systemd-x86_64.tar.gz
</span></span><span class=line><span class=cl>mv /usr/local/src/mariadb-10.11.7-linux-systemd-x86_64/* /usr/local/mariadb
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 为 MariaDB 开启 Jemalloc 支持</span>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s@executing mysqld_safe@executing mysqld_safe\nexport LD_PRELOAD=/usr/local/lib/libjemalloc.so@&#39;</span> /usr/local/mariadb/bin/mysqld_safe
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 更改相关文件中 MariaDB 安装位置</span>
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s@/usr/local/mysql@/usr/local/mariadb@g&#34;</span> /usr/local/mariadb/bin/mysqld_safe
</span></span></code></pre></div><h4 id=配置-mariadb>配置 MariaDB</h4><p>首先设置 Service 脚本，方便进行管理；这里主要设置一下安装路径和数据路径</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp /usr/local/mariadb/support-files/mysql.server /etc/init.d/mysql
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 更改 MariaDB安装位置</span>
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s@^basedir=.*@basedir=/usr/local/mariadb@&#34;</span> /etc/init.d/mysql
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 更改 MariaDB 数据位置</span>
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s@^datadir=.*@datadir=/data/mariadb@&#34;</span> /etc/init.d/mysql
</span></span><span class=line><span class=cl>chmod +x /etc/init.d/mysql
</span></span></code></pre></div><p>接着来配置下 <code>my.cnf</code> 文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; /etc/my.cnf <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>[client]
</span></span></span><span class=line><span class=cl><span class=s>port = 3306
</span></span></span><span class=line><span class=cl><span class=s>socket = /tmp/mysql.sock
</span></span></span><span class=line><span class=cl><span class=s>default-character-set = utf8mb4
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[mysqld]
</span></span></span><span class=line><span class=cl><span class=s>port = 3306
</span></span></span><span class=line><span class=cl><span class=s>socket = /tmp/mysql.sock
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>basedir = /usr/local/mariadb
</span></span></span><span class=line><span class=cl><span class=s>datadir = /data/mariadb
</span></span></span><span class=line><span class=cl><span class=s>pid-file = /data/mariadb/mysql.pid
</span></span></span><span class=line><span class=cl><span class=s>user = mysql
</span></span></span><span class=line><span class=cl><span class=s>bind-address = 0.0.0.0
</span></span></span><span class=line><span class=cl><span class=s>server-id = 1
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>init-connect = &#39;SET NAMES utf8mb4&#39;
</span></span></span><span class=line><span class=cl><span class=s>character-set-server = utf8mb4
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>skip-name-resolve
</span></span></span><span class=line><span class=cl><span class=s>#skip-networking
</span></span></span><span class=line><span class=cl><span class=s>back_log = 300
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>max_connections = 1000
</span></span></span><span class=line><span class=cl><span class=s>max_connect_errors = 6000
</span></span></span><span class=line><span class=cl><span class=s>open_files_limit = 65535
</span></span></span><span class=line><span class=cl><span class=s>table_open_cache = 128
</span></span></span><span class=line><span class=cl><span class=s>max_allowed_packet = 500M
</span></span></span><span class=line><span class=cl><span class=s>binlog_cache_size = 1M
</span></span></span><span class=line><span class=cl><span class=s>max_heap_table_size = 8M
</span></span></span><span class=line><span class=cl><span class=s>tmp_table_size = 16M
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>read_buffer_size = 2M
</span></span></span><span class=line><span class=cl><span class=s>read_rnd_buffer_size = 8M
</span></span></span><span class=line><span class=cl><span class=s>sort_buffer_size = 8M
</span></span></span><span class=line><span class=cl><span class=s>join_buffer_size = 8M
</span></span></span><span class=line><span class=cl><span class=s>key_buffer_size = 4M
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>thread_cache_size = 8
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>query_cache_type = 1
</span></span></span><span class=line><span class=cl><span class=s>query_cache_size = 8M
</span></span></span><span class=line><span class=cl><span class=s>query_cache_limit = 2M
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>ft_min_word_len = 4
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>log_bin = mysql-bin
</span></span></span><span class=line><span class=cl><span class=s>binlog_format = mixed
</span></span></span><span class=line><span class=cl><span class=s>expire_logs_days = 7
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>log_error = /data/mariadb/mysql-error.log
</span></span></span><span class=line><span class=cl><span class=s>slow_query_log = 1
</span></span></span><span class=line><span class=cl><span class=s>long_query_time = 1
</span></span></span><span class=line><span class=cl><span class=s>slow_query_log_file = /data/mariadb/mysql-slow.log
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>performance_schema = 0
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>#lower_case_table_names = 1
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>skip-external-locking
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>default_storage_engine = InnoDB
</span></span></span><span class=line><span class=cl><span class=s>innodb_file_per_table = 1
</span></span></span><span class=line><span class=cl><span class=s>innodb_open_files = 500
</span></span></span><span class=line><span class=cl><span class=s>innodb_buffer_pool_size = 64M
</span></span></span><span class=line><span class=cl><span class=s>innodb_write_io_threads = 4
</span></span></span><span class=line><span class=cl><span class=s>innodb_read_io_threads = 4
</span></span></span><span class=line><span class=cl><span class=s>innodb_purge_threads = 1
</span></span></span><span class=line><span class=cl><span class=s>innodb_flush_log_at_trx_commit = 2
</span></span></span><span class=line><span class=cl><span class=s>innodb_log_buffer_size = 2M
</span></span></span><span class=line><span class=cl><span class=s>innodb_log_file_size = 32M
</span></span></span><span class=line><span class=cl><span class=s>innodb_max_dirty_pages_pct = 90
</span></span></span><span class=line><span class=cl><span class=s>innodb_lock_wait_timeout = 120
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>bulk_insert_buffer_size = 8M
</span></span></span><span class=line><span class=cl><span class=s>myisam_sort_buffer_size = 8M
</span></span></span><span class=line><span class=cl><span class=s>myisam_max_sort_file_size = 10G
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>interactive_timeout = 28800
</span></span></span><span class=line><span class=cl><span class=s>wait_timeout = 28800
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[mysqldump]
</span></span></span><span class=line><span class=cl><span class=s>quick
</span></span></span><span class=line><span class=cl><span class=s>max_allowed_packet = 500M
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[myisamchk]
</span></span></span><span class=line><span class=cl><span class=s>key_buffer_size = 8M
</span></span></span><span class=line><span class=cl><span class=s>sort_buffer_size = 8M
</span></span></span><span class=line><span class=cl><span class=s>read_buffer = 4M
</span></span></span><span class=line><span class=cl><span class=s>write_buffer = 4M
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>然后进行如下修改：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 最大连接数，改为内存（单位：M）/3</span>
</span></span><span class=line><span class=cl><span class=nv>max_connections</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 内存 1500M - 2500M 改成如下：</span>
</span></span><span class=line><span class=cl><span class=nv>thread_cache_size</span> <span class=o>=</span> <span class=m>16</span>
</span></span><span class=line><span class=cl><span class=nv>query_cache_size</span> <span class=o>=</span> 16M
</span></span><span class=line><span class=cl><span class=nv>myisam_sort_buffer_size</span> <span class=o>=</span> 16M
</span></span><span class=line><span class=cl><span class=nv>key_buffer_size</span> <span class=o>=</span> 16M
</span></span><span class=line><span class=cl><span class=nv>innodb_buffer_pool_size</span> <span class=o>=</span> 128M
</span></span><span class=line><span class=cl><span class=nv>tmp_table_size</span> <span class=o>=</span> 32M
</span></span><span class=line><span class=cl><span class=nv>table_open_cache</span> <span class=o>=</span> <span class=m>256</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 内存 2500M - 3500M 改成如下：</span>
</span></span><span class=line><span class=cl><span class=nv>thread_cache_size</span> <span class=o>=</span> <span class=m>32</span>
</span></span><span class=line><span class=cl><span class=nv>query_cache_size</span> <span class=o>=</span> 32M
</span></span><span class=line><span class=cl><span class=nv>myisam_sort_buffer_size</span> <span class=o>=</span> 32M
</span></span><span class=line><span class=cl><span class=nv>key_buffer_size</span> <span class=o>=</span> 64M
</span></span><span class=line><span class=cl><span class=nv>innodb_buffer_pool_size</span> <span class=o>=</span> 512M
</span></span><span class=line><span class=cl><span class=nv>tmp_table_size</span> <span class=o>=</span> 64M
</span></span><span class=line><span class=cl><span class=nv>table_open_cache</span> <span class=o>=</span> <span class=m>512</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 内存大于 3500M 改成如下：</span>
</span></span><span class=line><span class=cl><span class=nv>thread_cache_size</span> <span class=o>=</span> <span class=m>64</span>
</span></span><span class=line><span class=cl><span class=nv>query_cache_size</span> <span class=o>=</span> 64M
</span></span><span class=line><span class=cl><span class=nv>myisam_sort_buffer_size</span> <span class=o>=</span> 64M
</span></span><span class=line><span class=cl><span class=nv>key_buffer_size</span> <span class=o>=</span> 256M
</span></span><span class=line><span class=cl><span class=nv>innodb_buffer_pool_size</span> <span class=o>=</span> 1024M
</span></span><span class=line><span class=cl><span class=nv>tmp_table_size</span> <span class=o>=</span> 128M
</span></span><span class=line><span class=cl><span class=nv>table_open_cache</span> <span class=o>=</span> <span class=m>1024</span>
</span></span></code></pre></div><p>创建必要文件、文件夹，并赋予权限</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>touch /tmp/mysql.sock
</span></span><span class=line><span class=cl>chown mysql:mysql /tmp/mysql.sock
</span></span><span class=line><span class=cl>mkdir -p /data/mariadb
</span></span><span class=line><span class=cl>touch /data/mariadb/<span class=o>{</span>mysql.pid,mysql-error.log,mysql-slow.log<span class=o>}</span>
</span></span><span class=line><span class=cl>chown -R mysql:mysql /data/mariadb
</span></span><span class=line><span class=cl>chmod <span class=m>664</span> /tmp/mysql.sock /data/mariadb/*
</span></span><span class=line><span class=cl>chown -R mysql:mysql /usr/local/mariadb
</span></span></code></pre></div><p>添加环境变量</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;export PATH=/usr/local/mariadb/bin:$PATH&#39;</span> &gt; /etc/profile.d/mysql.sh
</span></span><span class=line><span class=cl><span class=nb>source</span> /etc/profile.d/mysql.sh
</span></span></code></pre></div><p>接下来使用自带的脚本进行数据导入及初始化</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/usr/local/mariadb/scripts/mysql_install_db --user<span class=o>=</span>mysql --basedir<span class=o>=</span>/usr/local/mariadb/ --datadir<span class=o>=</span>/data/mariadb
</span></span></code></pre></div><p><img src=/archives/install_lcmp/1.png width=805 height=470 srcset="/archives/install_lcmp/1_hu5e0c1d4a3bced10ccd0956b80e01422d_73048_480x0_resize_box_3.png 480w, /archives/install_lcmp/1_hu5e0c1d4a3bced10ccd0956b80e01422d_73048_1024x0_resize_box_3.png 1024w" loading=lazy alt=初始化数据 class=gallery-image data-flex-grow=171 data-flex-basis=411px></p><p>完成之后，赋予 my.cnf 对应的权限并启动 MariaDB</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>chmod <span class=m>600</span> /etc/my.cnf
</span></span><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>service mysql start
</span></span></code></pre></div><p>然后执行下面命令进行安全设置，<code>dbrootpwd=</code> 设置为你要设置的密码</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>dbrootpwd</span><span class=o>=</span><span class=s2>&#34;password&#34;</span>
</span></span><span class=line><span class=cl>/usr/local/mariadb/bin/mysql -e <span class=s2>&#34;grant all privileges on *.* to root@&#39;127.0.0.1&#39; identified by \&#34;</span><span class=si>${</span><span class=nv>dbrootpwd</span><span class=si>}</span><span class=s2>\&#34; with grant option;&#34;</span>
</span></span><span class=line><span class=cl>/usr/local/mariadb/bin/mysql -e <span class=s2>&#34;grant all privileges on *.* to root@&#39;localhost&#39; identified by \&#34;</span><span class=si>${</span><span class=nv>dbrootpwd</span><span class=si>}</span><span class=s2>\&#34; with grant option;&#34;</span>
</span></span><span class=line><span class=cl>/usr/local/mariadb/bin/mysql -uroot -p<span class=si>${</span><span class=nv>dbrootpwd</span><span class=si>}</span> -e <span class=s2>&#34;delete from mysql.user where Password=&#39;&#39; and User not like &#39;mariadb.%&#39;;&#34;</span>
</span></span><span class=line><span class=cl>/usr/local/mariadb/bin/mysql -uroot -p<span class=si>${</span><span class=nv>dbrootpwd</span><span class=si>}</span> -e <span class=s2>&#34;delete from mysql.db where User=&#39;&#39;;&#34;</span>
</span></span><span class=line><span class=cl>/usr/local/mariadb/bin/mysql -uroot -p<span class=si>${</span><span class=nv>dbrootpwd</span><span class=si>}</span> -e <span class=s2>&#34;delete from mysql.proxies_priv where Host!=&#39;localhost&#39;;&#34;</span>
</span></span><span class=line><span class=cl>/usr/local/mariadb/bin/mysql -uroot -p<span class=si>${</span><span class=nv>dbrootpwd</span><span class=si>}</span> -e <span class=s2>&#34;drop database test;&#34;</span>
</span></span><span class=line><span class=cl>/usr/local/mariadb/bin/mysql -uroot -p<span class=si>${</span><span class=nv>dbrootpwd</span><span class=si>}</span> -e <span class=s2>&#34;reset master;&#34;</span>
</span></span></code></pre></div><p>完成安全设置后为 MariaDB 链接动态库</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;/usr/local/mariadb/lib&#34;</span> &gt; /etc/ld.so.conf.d/mariadb.conf
</span></span><span class=line><span class=cl>ldconfig
</span></span></code></pre></div><hr><h3 id=安装-php>安装 PHP</h3><h4 id=准备工作>准备工作</h4><p>在安装 PHP 之前，需要编译安装 libiconv</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /usr/local/src
</span></span><span class=line><span class=cl>wget https://ftp.gnu.org/gnu/libiconv/libiconv-1.17.tar.gz
</span></span><span class=line><span class=cl>tar zxf libiconv-1.17.tar.gz
</span></span><span class=line><span class=cl><span class=nb>cd</span> libiconv-1.17
</span></span><span class=line><span class=cl>./configure
</span></span><span class=line><span class=cl>make -j<span class=k>$(</span>nproc<span class=k>)</span>
</span></span><span class=line><span class=cl>make install
</span></span></code></pre></div><p>链接动态库</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;/usr/local/lib&#39;</span> &gt; /etc/ld.so.conf.d/libc.conf
</span></span><span class=line><span class=cl>ldconfig
</span></span></code></pre></div><h4 id=源码编译安装>源码编译安装</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /usr/local/src
</span></span><span class=line><span class=cl>wget https://secure.php.net/distributions/php-8.2.16.tar.gz
</span></span><span class=line><span class=cl>tar zxf php-8.2.16.tar.gz
</span></span><span class=line><span class=cl><span class=nb>cd</span> php-8.2.16
</span></span><span class=line><span class=cl>mkdir build-php <span class=o>&amp;&amp;</span> <span class=nb>cd</span> build-php
</span></span><span class=line><span class=cl>../configure --prefix<span class=o>=</span>/usr/local/php <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-config-file-path<span class=o>=</span>/usr/local/php/etc <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-config-file-scan-dir<span class=o>=</span>/usr/local/php/etc/php.d <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-fpm-user<span class=o>=</span>caddy <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-fpm-group<span class=o>=</span>caddy <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-mysqli<span class=o>=</span>mysqlnd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-pdo-mysql<span class=o>=</span>mysqlnd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-iconv<span class=o>=</span>/usr/local/ <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-freetype <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-jpeg <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-zlib <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-password-argon2 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-sodium <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-curl <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-openssl <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-mhash <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-xsl <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-gettext <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-zip <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-fpm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-opcache <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-mysqlnd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-xml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-bcmath <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-shmop <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-exif <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-sysvsem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-mbregex <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-mbstring <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-gd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-pcntl <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-sockets <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-ftp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-intl <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-soap <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--disable-fileinfo <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--disable-rpath <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--disable-debug
</span></span><span class=line><span class=cl>make <span class=nv>ZEND_EXTRA_LIBS</span><span class=o>=</span><span class=s1>&#39;-liconv&#39;</span> -j <span class=k>$(</span>nproc<span class=k>)</span>
</span></span><span class=line><span class=cl>make install
</span></span></code></pre></div><p>为 PHP 添加环境变量</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;export PATH=/usr/local/php/bin:\$PATH&#34;</span> &gt; /etc/profile.d/php.sh
</span></span><span class=line><span class=cl><span class=nb>source</span> /etc/profile.d/php.sh
</span></span></code></pre></div><p>复制 php.ini 配置并进行修改</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp /usr/local/src/php-8.2.16/php.ini-production /usr/local/php/etc/php.ini
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改以下部分</span>
</span></span><span class=line><span class=cl><span class=nv>memory_limit</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl><span class=nv>output_buffering</span> <span class=o>=</span> On
</span></span><span class=line><span class=cl><span class=nv>short_open_tag</span> <span class=o>=</span> On
</span></span><span class=line><span class=cl><span class=nv>expose_php</span> <span class=o>=</span> Off
</span></span><span class=line><span class=cl><span class=nv>equest_order</span> <span class=o>=</span> <span class=s2>&#34;CGP&#34;</span>
</span></span><span class=line><span class=cl>date.timezone <span class=o>=</span> Asia/Shanghai
</span></span><span class=line><span class=cl><span class=nv>post_max_size</span> <span class=o>=</span> 100M
</span></span><span class=line><span class=cl><span class=nv>upload_max_filesize</span> <span class=o>=</span> 50M
</span></span><span class=line><span class=cl><span class=nv>max_execution_time</span> <span class=o>=</span> <span class=m>600</span>
</span></span><span class=line><span class=cl><span class=nv>realpath_cache_size</span> <span class=o>=</span> 2M
</span></span><span class=line><span class=cl><span class=nv>disable_functions</span> <span class=o>=</span> passthru,exec,system,chroot,chgrp,chown,shell_exec,proc_open,proc_get_status,ini_alter,ini_restore,dl,readlink,symlink,popepassthru,stream_socket_server,fsocket,popen
</span></span></code></pre></div><p>其中 <code>memory_limit</code> 项参数如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 内存小于 640M</span>
</span></span><span class=line><span class=cl><span class=nv>memory_limit</span> <span class=o>=</span> <span class=m>64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 内存为 640M - 1280M</span>
</span></span><span class=line><span class=cl><span class=nv>memory_limit</span> <span class=o>=</span> <span class=m>128</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 内存为 1280M - 2500M</span>
</span></span><span class=line><span class=cl><span class=nv>memory_limit</span> <span class=o>=</span> <span class=m>192</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 内存为 2500M - 3500M</span>
</span></span><span class=line><span class=cl><span class=nv>memory_limit</span> <span class=o>=</span> <span class=m>256</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 内存为 3500M - 4500M</span>
</span></span><span class=line><span class=cl><span class=nv>memory_limit</span> <span class=o>=</span> <span class=m>320</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 内存为 4500M - 8000M</span>
</span></span><span class=line><span class=cl><span class=nv>memory_limit</span> <span class=o>=</span> <span class=m>384</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#内存大于 8000M</span>
</span></span><span class=line><span class=cl><span class=nv>memory_limit</span> <span class=o>=</span> <span class=m>448</span>
</span></span></code></pre></div><p>接下来为 PHP 开启 OPcache 缓存并进行配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; /usr/local/php/etc/php.d/opcache.ini <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>[opcache]
</span></span></span><span class=line><span class=cl><span class=s>zend_extension=opcache.so
</span></span></span><span class=line><span class=cl><span class=s>opcache.enable=1
</span></span></span><span class=line><span class=cl><span class=s>opcache.enable_cli=1
</span></span></span><span class=line><span class=cl><span class=s>opcache.memory_consumption=
</span></span></span><span class=line><span class=cl><span class=s>opcache.interned_strings_buffer=8
</span></span></span><span class=line><span class=cl><span class=s>opcache.max_accelerated_files=100000
</span></span></span><span class=line><span class=cl><span class=s>opcache.max_wasted_percentage=5
</span></span></span><span class=line><span class=cl><span class=s>opcache.use_cwd=1
</span></span></span><span class=line><span class=cl><span class=s>opcache.validate_timestamps=1
</span></span></span><span class=line><span class=cl><span class=s>opcache.revalidate_freq=60
</span></span></span><span class=line><span class=cl><span class=s>;opcache.save_comments=0
</span></span></span><span class=line><span class=cl><span class=s>opcache.consistency_checks=0
</span></span></span><span class=line><span class=cl><span class=s>;opcache.optimization_level=0
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>其中 <code>opcache.memory_consumption=</code> 项，与上文 <strong>php.ini</strong> 中 <code>memory_limit</code> 一致</p><p>添加 php-fpm 启动脚本，并设置开机自启</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; /usr/lib/systemd/system/php-fpm.service <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=The PHP FastCGI Process Manager
</span></span></span><span class=line><span class=cl><span class=s>Documentation=http://php.net/docs.php
</span></span></span><span class=line><span class=cl><span class=s>After=network.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>Type=simple
</span></span></span><span class=line><span class=cl><span class=s>PIDFile=/usr/local/php/var/run/php-fpm.pid
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/php/sbin/php-fpm --nodaemonize --fpm-config usr/local/php/etc/php-fpm.conf
</span></span></span><span class=line><span class=cl><span class=s>ExecReload=/bin/kill -USR2 $MAINPID
</span></span></span><span class=line><span class=cl><span class=s>LimitNOFILE=1000000
</span></span></span><span class=line><span class=cl><span class=s>LimitNPROC=1000000
</span></span></span><span class=line><span class=cl><span class=s>LimitCORE=1000000
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> php-fpm
</span></span></code></pre></div><p>接着还需要添加 php-fpm 配置文件，并进行配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; /usr/local/php/etc/php-fpm.conf <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class=line><span class=cl><span class=s>; FPM Configuration ;
</span></span></span><span class=line><span class=cl><span class=s>;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>;;;;;;;;;;;;;;;;;;
</span></span></span><span class=line><span class=cl><span class=s>; Global Options ;
</span></span></span><span class=line><span class=cl><span class=s>;;;;;;;;;;;;;;;;;;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[global]
</span></span></span><span class=line><span class=cl><span class=s>pid = run/php-fpm.pid
</span></span></span><span class=line><span class=cl><span class=s>error_log = log/php-fpm.log
</span></span></span><span class=line><span class=cl><span class=s>log_level = warning
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>emergency_restart_threshold = 30
</span></span></span><span class=line><span class=cl><span class=s>emergency_restart_interval = 60s
</span></span></span><span class=line><span class=cl><span class=s>process_control_timeout = 5s
</span></span></span><span class=line><span class=cl><span class=s>daemonize = yes
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class=line><span class=cl><span class=s>; Pool Definitions ;
</span></span></span><span class=line><span class=cl><span class=s>;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[caddy]
</span></span></span><span class=line><span class=cl><span class=s>listen = /dev/shm/php-cgi.sock
</span></span></span><span class=line><span class=cl><span class=s>listen.backlog = -1
</span></span></span><span class=line><span class=cl><span class=s>listen.allowed_clients = 127.0.0.1
</span></span></span><span class=line><span class=cl><span class=s>listen.owner = caddy
</span></span></span><span class=line><span class=cl><span class=s>listen.group = caddy
</span></span></span><span class=line><span class=cl><span class=s>listen.mode = 0666
</span></span></span><span class=line><span class=cl><span class=s>user = caddy
</span></span></span><span class=line><span class=cl><span class=s>group = caddy
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>pm = dynamic
</span></span></span><span class=line><span class=cl><span class=s>pm.max_children = 12
</span></span></span><span class=line><span class=cl><span class=s>pm.start_servers = 8
</span></span></span><span class=line><span class=cl><span class=s>pm.min_spare_servers = 6
</span></span></span><span class=line><span class=cl><span class=s>pm.max_spare_servers = 12
</span></span></span><span class=line><span class=cl><span class=s>pm.max_requests = 2048
</span></span></span><span class=line><span class=cl><span class=s>pm.process_idle_timeout = 10s
</span></span></span><span class=line><span class=cl><span class=s>request_terminate_timeout = 120
</span></span></span><span class=line><span class=cl><span class=s>request_slowlog_timeout = 0
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>pm.status_path = /php-fpm_status
</span></span></span><span class=line><span class=cl><span class=s>slowlog = var/log/slow.log
</span></span></span><span class=line><span class=cl><span class=s>rlimit_files = 51200
</span></span></span><span class=line><span class=cl><span class=s>rlimit_core = 0
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>catch_workers_output = yes
</span></span></span><span class=line><span class=cl><span class=s>;env[HOSTNAME] = $HOSTNAME
</span></span></span><span class=line><span class=cl><span class=s>env[PATH] = /usr/local/bin:/usr/bin:/bin
</span></span></span><span class=line><span class=cl><span class=s>env[TMP] = /tmp
</span></span></span><span class=line><span class=cl><span class=s>env[TMPDIR] = /tmp
</span></span></span><span class=line><span class=cl><span class=s>env[TEMP] = /tmp
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>进行如下修改：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 内存小于 3000M</span>
</span></span><span class=line><span class=cl>pm.max_children <span class=o>=</span> 内存（单位：M） /3/20
</span></span><span class=line><span class=cl>pm.start_servers <span class=o>=</span> 内存（单位：M） /3/30
</span></span><span class=line><span class=cl>pm.min_spare_servers <span class=o>=</span> 内存（单位：M） /3/40
</span></span><span class=line><span class=cl>pm.max_spare_servers <span class=o>=</span> 内存（单位：M） /3/20
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 内存为 3000M - 4500M</span>
</span></span><span class=line><span class=cl>pm.max_children <span class=o>=</span> <span class=m>50</span>
</span></span><span class=line><span class=cl>pm.start_servers <span class=o>=</span> <span class=m>30</span>
</span></span><span class=line><span class=cl>pm.min_spare_servers <span class=o>=</span> <span class=m>20</span>
</span></span><span class=line><span class=cl>pm.max_spare_servers <span class=o>=</span> <span class=m>50</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 内存为 4500M - 6500M</span>
</span></span><span class=line><span class=cl>pm.max_children <span class=o>=</span> <span class=m>60</span>
</span></span><span class=line><span class=cl>pm.start_servers <span class=o>=</span> <span class=m>40</span>
</span></span><span class=line><span class=cl>pm.min_spare_servers <span class=o>=</span> <span class=m>30</span>
</span></span><span class=line><span class=cl>pm.max_spare_servers <span class=o>=</span> <span class=m>60</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 内存为 6500M - 8500M</span>
</span></span><span class=line><span class=cl>pm.max_children <span class=o>=</span> <span class=m>70</span>
</span></span><span class=line><span class=cl>pm.start_servers <span class=o>=</span> <span class=m>50</span>
</span></span><span class=line><span class=cl>pm.min_spare_servers <span class=o>=</span> <span class=m>40</span>
</span></span><span class=line><span class=cl>pm.max_spare_servers <span class=o>=</span> <span class=m>70</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 内存大于 8500M</span>
</span></span><span class=line><span class=cl>pm.max_children <span class=o>=</span> <span class=m>80</span>
</span></span><span class=line><span class=cl>pm.start_servers <span class=o>=</span> <span class=m>60</span>
</span></span><span class=line><span class=cl>pm.min_spare_servers <span class=o>=</span> <span class=m>50</span>
</span></span><span class=line><span class=cl>pm.max_spare_servers <span class=o>=</span> <span class=m>80</span>
</span></span></code></pre></div><hr><h3 id=安装php-扩展>安装PHP 扩展</h3><h4 id=redis-扩展>Redis 扩展</h4><p>下载 Redis Server 和 PECL Redis</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /usr/local/src
</span></span><span class=line><span class=cl>wget https://github.com/redis/redis/archive/7.2.4.tar.gz
</span></span><span class=line><span class=cl>wget https://pecl.php.net/get/redis-6.0.2.tgz
</span></span></code></pre></div><p>编译安装 Redis Srever</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p /usr/local/redis/<span class=o>{</span>etc,var<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /usr/local/src
</span></span><span class=line><span class=cl>tar zxf 7.2.4.tar.gz
</span></span><span class=line><span class=cl><span class=nb>cd</span> redis-7.2.4
</span></span><span class=line><span class=cl>make -j<span class=k>$(</span>nproc<span class=k>)</span>
</span></span><span class=line><span class=cl>make <span class=nv>PREFIX</span><span class=o>=</span>/usr/local/redis install
</span></span></code></pre></div><p>将 bin 目录下可执行文件进行链接并配置 redis</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ln -s /usr/local/redis/bin/* /usr/local/bin/
</span></span><span class=line><span class=cl>cp /usr/local/src/redis-7.2.4/redis.conf /usr/local/redis/etc/
</span></span><span class=line><span class=cl>vim /usr/local/redis/etc/redis.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 改成如下</span>
</span></span><span class=line><span class=cl>pidfile /var/run/redis/redis.pid
</span></span><span class=line><span class=cl>logfile /usr/local/redis/var/redis.log
</span></span><span class=line><span class=cl>dir /usr/local/redis/var
</span></span><span class=line><span class=cl>daemonize yes
</span></span><span class=line><span class=cl><span class=nb>bind</span> 127.0.0.1 ::1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># maxmemory 计算方法：内存（单位：M）/8*1000000</span>
</span></span><span class=line><span class=cl>maxmemory <span class=m>512000000</span>
</span></span></code></pre></div><p>添加用户 并设置文件夹权限</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>useradd -M -s /sbin/nologin redis
</span></span><span class=line><span class=cl>chown -R redis:redis /usr/local/redis/<span class=o>{</span>var,etc<span class=o>}</span>
</span></span></code></pre></div><p>添加 Redis Server 启动脚本，并设置开机自启</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; /usr/lib/systemd/system/redis-server.service <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Redis In-Memory Data Store
</span></span></span><span class=line><span class=cl><span class=s>After=network.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>Type=forking
</span></span></span><span class=line><span class=cl><span class=s>PIDFile=/var/run/redis/redis.pid
</span></span></span><span class=line><span class=cl><span class=s>User=redis
</span></span></span><span class=line><span class=cl><span class=s>Group=redis
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>Environment=statedir=/var/run/redis
</span></span></span><span class=line><span class=cl><span class=s>PermissionsStartOnly=true
</span></span></span><span class=line><span class=cl><span class=s>ExecStartPre=/bin/mkdir -p ${statedir}
</span></span></span><span class=line><span class=cl><span class=s>ExecStartPre=/bin/chown -R redis:redis ${statedir}
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/redis/bin/redis-server /usr/local/redis/etc/redis.conf
</span></span></span><span class=line><span class=cl><span class=s>ExecStop=/bin/kill -s TERM $MAINPID
</span></span></span><span class=line><span class=cl><span class=s>Restart=always
</span></span></span><span class=line><span class=cl><span class=s>LimitNOFILE=1000000
</span></span></span><span class=line><span class=cl><span class=s>LimitNPROC=1000000
</span></span></span><span class=line><span class=cl><span class=s>LimitCORE=1000000
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> redis-server
</span></span><span class=line><span class=cl>systemctl start redis-server
</span></span></code></pre></div><p>接着安装 PECL Redis 并为 PHP 开启 PECL Redis 扩展</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /usr/local/src
</span></span><span class=line><span class=cl>tar zxf redis-6.0.2.tgz
</span></span><span class=line><span class=cl><span class=nb>cd</span> redis-6.0.2
</span></span><span class=line><span class=cl>/usr/local/php/bin/phpize
</span></span><span class=line><span class=cl>./configure --with-php-config<span class=o>=</span>/usr/local/php/bin/php-config
</span></span><span class=line><span class=cl>make -j<span class=k>$(</span>nproc<span class=k>)</span>
</span></span><span class=line><span class=cl>make install
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;extension=redis.so&#39;</span> &gt; /usr/local/php/etc/php.d/redis.ini
</span></span></code></pre></div><h4 id=memcached-扩展>Memcached 扩展</h4><p>首先需要下载 Memcached、libMemcached 和 PECL Memcached</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /usr/local/src
</span></span><span class=line><span class=cl>wget https://memcached.org/files/memcached-1.6.24.tar.gz
</span></span><span class=line><span class=cl>wget https://launchpad.net/libmemcached/1.0/1.0.18/+download/libmemcached-1.0.18.tar.gz
</span></span><span class=line><span class=cl>wget https://pecl.php.net/get/memcached-3.2.0.tgz
</span></span></code></pre></div><p>开始编译安装 Memcached</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 添加用户</span>
</span></span><span class=line><span class=cl>useradd -M -s /sbin/nologin memcached
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /usr/local/src
</span></span><span class=line><span class=cl>tar zxf memcached-1.6.24.tar.gz
</span></span><span class=line><span class=cl><span class=nb>cd</span> memcached-1.6.24
</span></span><span class=line><span class=cl>./configure --prefix<span class=o>=</span>/usr/local/memcached
</span></span><span class=line><span class=cl>make -j<span class=k>$(</span>nproc<span class=k>)</span>
</span></span><span class=line><span class=cl>make install
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 链接可执行文件</span>
</span></span><span class=line><span class=cl>ln -s /usr/local/memcached/bin/memcached /usr/bin/memcached
</span></span></code></pre></div><p>添加 Memcached 启动脚本，并设置开机自启</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; /usr/lib/systemd/system/memcached.service <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=memcached daemon
</span></span></span><span class=line><span class=cl><span class=s>After=network.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>Environment=PORT=11211
</span></span></span><span class=line><span class=cl><span class=s>Environment=USER=memcached
</span></span></span><span class=line><span class=cl><span class=s>Environment=MAXCONN=1024
</span></span></span><span class=line><span class=cl><span class=s>Environment=CACHESIZE=256
</span></span></span><span class=line><span class=cl><span class=s>Environment=&#34;OPTIONS=-l 127.0.0.1&#34;
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/bin/memcached -p ${PORT} -u ${USER} -m ${CACHESIZE} -c ${MAXCONN} $OPTIONS
</span></span></span><span class=line><span class=cl><span class=s>PrivateTmp=true
</span></span></span><span class=line><span class=cl><span class=s>ProtectSystem=full
</span></span></span><span class=line><span class=cl><span class=s>NoNewPrivileges=true
</span></span></span><span class=line><span class=cl><span class=s>PrivateDevices=true
</span></span></span><span class=line><span class=cl><span class=s>CapabilityBoundingSet=CAP_SETGID CAP_SETUID CAP_SYS_RESOURCE
</span></span></span><span class=line><span class=cl><span class=s>RestrictAddressFamilies=AF_INET AF_INET6 AF_UNIX
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> memcached
</span></span><span class=line><span class=cl>systemctl start memcached
</span></span></code></pre></div><p>在编译安装之前先给 libMencached 打个补丁</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /usr/local/src
</span></span><span class=line><span class=cl>tar zxf libmemcached-1.0.18.tar.gz
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; libmemcached-build.patch <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>diff -up ./clients/memflush.cc.old ./clients/memflush.cc
</span></span></span><span class=line><span class=cl><span class=s>--- ./clients/memflush.cc.old	2017-02-12 10:12:59.615209225 +0100
</span></span></span><span class=line><span class=cl><span class=s>+++ ./clients/memflush.cc	2017-02-12 10:13:39.998382783 +0100
</span></span></span><span class=line><span class=cl><span class=s>@@ -39,7 +39,7 @@ int main(int argc, char *argv[])
</span></span></span><span class=line><span class=cl><span class=s> {
</span></span></span><span class=line><span class=cl><span class=s>   options_parse(argc, argv);
</span></span></span><span class=line><span class=cl><span class=s> 
</span></span></span><span class=line><span class=cl><span class=s>-  if (opt_servers == false)
</span></span></span><span class=line><span class=cl><span class=s>+  if (!opt_servers)
</span></span></span><span class=line><span class=cl><span class=s>   {
</span></span></span><span class=line><span class=cl><span class=s>     char *temp;
</span></span></span><span class=line><span class=cl><span class=s> 
</span></span></span><span class=line><span class=cl><span class=s>@@ -48,7 +48,7 @@ int main(int argc, char *argv[])
</span></span></span><span class=line><span class=cl><span class=s>       opt_servers= strdup(temp);
</span></span></span><span class=line><span class=cl><span class=s>     }
</span></span></span><span class=line><span class=cl><span class=s> 
</span></span></span><span class=line><span class=cl><span class=s>-    if (opt_servers == false)
</span></span></span><span class=line><span class=cl><span class=s>+    if (!opt_servers)
</span></span></span><span class=line><span class=cl><span class=s>     {
</span></span></span><span class=line><span class=cl><span class=s>       std::cerr &lt;&lt; &#34;No Servers provided&#34; &lt;&lt; std::endl;
</span></span></span><span class=line><span class=cl><span class=s>       exit(EXIT_FAILURE);
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>patch -d libmemcached-1.0.18 -p0 &lt; libmemcached-build.patch
</span></span></code></pre></div><p>然后编译安装 libMencached</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> libmemcached-1.0.18
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s@lthread -pthread -pthreads@lthread -lpthread -pthreads@&#34;</span> ./configure
</span></span><span class=line><span class=cl>./configure --with-memcached<span class=o>=</span>/usr/local/memcached
</span></span><span class=line><span class=cl>make -j<span class=k>$(</span>nproc<span class=k>)</span>
</span></span><span class=line><span class=cl>make install
</span></span></code></pre></div><p>接下来编译安装 PECL Memcached 并为 PHP 开启 Memcached 扩展</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /usr/local/src
</span></span><span class=line><span class=cl>tar zxf memcached-3.2.0.tgz
</span></span><span class=line><span class=cl><span class=nb>cd</span> memcached-3.2.0
</span></span><span class=line><span class=cl>/usr/local/php/bin/phpize
</span></span><span class=line><span class=cl>./configure --with-php-config<span class=o>=</span>/usr/local/php/bin/php-config
</span></span><span class=line><span class=cl>make -j<span class=k>$(</span>nproc<span class=k>)</span>
</span></span><span class=line><span class=cl>make install
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; /usr/local/php/etc/php.d/memcached.ini <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>extension=memcached.so
</span></span></span><span class=line><span class=cl><span class=s>memcached.use_sasl=1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h4 id=imagick-扩展>Imagick 扩展</h4><p>下载 Imagemagick 和 PECL Imagick</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /usr/local/src
</span></span><span class=line><span class=cl>wget https://imagemagick.org/archive/ImageMagick.tar.gz
</span></span><span class=line><span class=cl>wget https://pecl.php.net/get/imagick-3.7.0.tgz
</span></span></code></pre></div><p>编译安装 Imagemagick</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /usr/local/src
</span></span><span class=line><span class=cl>tar zxf ImageMagick.tar.gz
</span></span><span class=line><span class=cl><span class=nb>cd</span> ImageMagick-7.1.1-29
</span></span><span class=line><span class=cl>./configure --prefix<span class=o>=</span>/usr/local/imagemagick <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-shared <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-static
</span></span><span class=line><span class=cl>make -j<span class=k>$(</span>nproc<span class=k>)</span>
</span></span><span class=line><span class=cl>make install
</span></span></code></pre></div><p>编译安装 PECL Imagick 并为 PHP 开启 Imagick 扩展</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /usr/local/src
</span></span><span class=line><span class=cl>tar zxf imagick-3.7.0.tgz
</span></span><span class=line><span class=cl><span class=nb>cd</span> imagick-3.7.0
</span></span><span class=line><span class=cl>/usr/local/php/bin/phpize
</span></span><span class=line><span class=cl>./configure --with-php-config<span class=o>=</span>/usr/local/php/bin/php-config <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-imagick<span class=o>=</span>/usr/local/imagemagick
</span></span><span class=line><span class=cl>make -j<span class=k>$(</span>nproc<span class=k>)</span>
</span></span><span class=line><span class=cl>make install
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;extension=imagick.so&#39;</span> &gt; /usr/local/php/etc/php.d/imagick.ini
</span></span></code></pre></div><hr><p>至此 Caddy2 + MariaDB + PHP 安装完成</p><p>另外需要注意网站根目录权限，网站根目录权限应遵循：
文件 644 文件夹 755 权限用户和用户组 caddy ，其余文档 777 权限是不正常的
如出现文件权限问题时，请执行下面 3 条命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>chown -R caddy:caddy /data/www/
</span></span><span class=line><span class=cl>find /data/www/ -type d -exec chmod <span class=m>755</span> <span class=o>{}</span> <span class=se>\;</span>
</span></span><span class=line><span class=cl>find /data/www/ -type f -exec chmod <span class=m>644</span> <span class=o>{}</span> <span class=se>\;</span>
</span></span></code></pre></div></section><footer class=article-footer><section class=article-tags><a href=/tags/linux/>Linux</a>
<a href=/tags/caddy/>Caddy</a>
<a href=/tags/mariadb/>MariaDB</a>
<a href=/tags/php/>PHP</a>
<a href=/tags/web/>Web</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><footer class=site-footer><section class=powerby>&copy;
2024 <b>Kitin</b>&nbsp;&#183;&nbsp;Built with <b><a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></b> &
        <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.23.0>Stack</a></b> Theme</section><br><section class=copyright><img src=/img/pc.svg alt=PC width=14px height=14px> <a href="https://beian.mps.gov.cn/#/query/webSearch?code=36010302000981" rel=noreferrer target=_blank>赣公网安备36010302000981</a><br><img src=/img/icp.svg alt=ICP width=14px height=14px> <a href=https://beian.miit.gov.cn/ target=_blank>赣ICP备2024024305号-1</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script src=https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/js/nprogress.min.js integrity=sha384-bHDlAEUFxsRI7JfULv3DTpL2IXbbgn4JHQJibgo5iiXSK6Iu8muwqHANhun74Cqg crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/css/nprogress.css integrity=sha384-KJyhr2syt5+4M9Pz5dipCvTrtvOmLk/olWVdfhAp858UCa64Ia5GFpTN7+G4BWpE crossorigin=anonymous><script>NProgress.start(),document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&NProgress.inc(.8),document.readyState==="complete"&&NProgress.done()})</script></body></html>