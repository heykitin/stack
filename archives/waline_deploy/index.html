<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='使用 Caddy+MariaDB/MySQL 在你的服务器上独立部署 Waline 服务端'><title>Waline 服务端独立部署方案</title>
<link rel=canonical href=/archives/waline_deploy/><link rel=stylesheet href=/scss/style.min.b776c29aa15014c4b8af17594eb9f36bfbf1da196ecd5914461a5869aec7ef58.css><meta property='og:title' content='Waline 服务端独立部署方案'><meta property='og:description' content='使用 Caddy+MariaDB/MySQL 在你的服务器上独立部署 Waline 服务端'><meta property='og:url' content='/archives/waline_deploy/'><meta property='og:site_name' content="Kitin's"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Hugo'><meta property='article:tag' content='Blog'><meta property='article:tag' content='Caddy'><meta property='article:tag' content='MySQL'><meta property='article:tag' content='MariaDB'><meta property='article:tag' content='Waline'><meta property='article:published_time' content='2022-10-20T10:50:47+08:00'><meta property='article:modified_time' content='2022-10-23T10:50:47+08:00'><meta name=twitter:title content="Waline 服务端独立部署方案"><meta name=twitter:description content="使用 Caddy+MariaDB/MySQL 在你的服务器上独立部署 Waline 服务端"><link rel="shortcut icon" href=/favicon.ico><style>:root{--article-font-family:"Noto Serif SC", var(--base-font-family)}</style><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu3062918ec655b699aef6c10c56bc778d_207173_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Kitin's</a></h1><h2 class=site-description></h2></div></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#前言>前言</a></li><li><a href=#部署过程>部署过程</a><ol><li><a href=#准备工作>准备工作</a></li><li><a href=#安装-nodejs>安装 Nodejs</a><ol><li><a href=#包管理器安装>包管理器安装</a></li><li><a href=#二进制安装>二进制安装</a></li><li><a href=#源码编译安装>源码编译安装</a></li></ol></li><li><a href=#安装-waline>安装 Waline</a><ol><li><a href=#更换镜像>更换镜像</a></li></ol></li><li><a href=#配置数据库>配置数据库</a></li><li><a href=#配置-systemd-服务>配置 systemd 服务</a></li><li><a href=#反向代理设置>反向代理设置</a><ol><li><a href=#caddy>Caddy</a></li><li><a href=#nginx>Nginx</a></li></ol></li></ol></li><li><a href=#总结>总结</a><ol><li><a href=#参考资料>参考资料</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/archives/waline_deploy/>Waline 服务端独立部署方案</a></h2><h3 class=article-subtitle>使用 Caddy+MariaDB/MySQL 在你的服务器上独立部署 Waline 服务端</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Oct 20, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 5 分钟</time></div></footer></div></header><section class=article-content><h2 id=前言>前言</h2><p>之前讲了通过 Vercel 来进行 Waline 服务端的部署，这是最简单，也是完全免费的方法；但是对于拥有自己服务器的人来说，可能更想要将 Waline 直接部署到自己的服务器上；毕竟服务器摆在那，不用也是浪费，何不将 Waline 服务端也部署自己的服务器上以方便进行管理呢？其实 Waline 提供了很多的部署方案，可以看 <a class=link href=https://waline.js.org/advanced/intro.html target=_blank rel=noopener>这里
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>；因为我一直使用的 Caddy 所以我就用 Caddy+MariaDB/MySQL 的方式来搭建，这里记录一下踩坑过程；当然你使用 Nginx/Apache 加上其他数据库的组合也是可以的。</p><h2 id=部署过程>部署过程</h2><h3 id=准备工作>准备工作</h3><p>域名解析这块就不多讲了，提前绑定到你的服务器 IP ；服务器基本配置与优化可以参考 <a class=link href=/archives/setvps>这里
</a>；至于 Web 服务这块，如果你使用 Nginx/Apache+MariaDB/MySQL 可以看 <a class=link href=/archives/oneinstack>这里
</a>搭建好 Web 服务与数据库。</p><p>如果你想和我一样使用 Caddy Server 那么你可以参考 <a class=link href=/archives/caddy>这里
</a>先搭建 Caddy Server ；然后来安装数据库，我这里以 MariaDB/MySQL 为例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt update
</span></span><span class=line><span class=cl>apt install mariadb-server -y
</span></span></code></pre></div><p>安装完 MariaDB 后，键入以下命令来进行初始化：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mysql_secure_installation
</span></span></code></pre></div><p>然后根据下面提示进行操作：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mysql_secure_installation
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Enter current password <span class=k>for</span> root <span class=o>(</span>enter <span class=k>for</span> none<span class=o>)</span>: <span class=c1># 输入数据库密码，由于并未设置，所以直接回车</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Set root password? <span class=o>[</span>Y/n<span class=o>]</span> y <span class=c1># 是否设置数据库 root 密码</span>
</span></span><span class=line><span class=cl>New password:
</span></span><span class=line><span class=cl>Re-enter new password: <span class=c1># 输入两次数据库 root 密码</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Remove anonymous users? <span class=o>[</span>Y/n<span class=o>]</span> y <span class=c1># 是否移除匿名用户</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Disallow root login remotely? <span class=o>[</span>Y/n<span class=o>]</span> y <span class=c1># 是否禁用 root 远程登陆</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Remove <span class=nb>test</span> database and access to it? <span class=o>[</span>Y/n<span class=o>]</span> y <span class=c1># 是否移除测试数据库</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Reload privilege tables now? <span class=o>[</span>Y/n<span class=o>]</span> y <span class=c1># 是否初始化数据库</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>All <span class=k>done</span>!  If you<span class=err>&#39;</span>ve completed all of the above steps, your MariaDB
</span></span><span class=line><span class=cl>installation should now be secure.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Thanks <span class=k>for</span> using MariaDB!
</span></span></code></pre></div><p>如果你需要用软件进行远程管理数据库，那么就不要禁用远程登陆，并且需要通过防火墙来开放 <code>3306</code> 端口</p><hr><h3 id=安装-nodejs>安装 Nodejs</h3><p>这里要注意，不要直接使用 <code>apt install</code> 进行安装，会导致后面报错，具体原因我也不知道。所以我们可以通过包管理器、二进制文件或者源码编译进行安装。</p><h4 id=包管理器安装>包管理器安装</h4><p>输入以下命令进行安装：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt-get update
</span></span><span class=line><span class=cl>apt-get install -y ca-certificates curl gnupg
</span></span><span class=line><span class=cl>mkdir -p /etc/apt/keyrings
</span></span><span class=line><span class=cl>curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key <span class=p>|</span> gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
</span></span><span class=line><span class=cl><span class=nv>NODE_MAJOR</span><span class=o>=</span><span class=m>16</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_</span><span class=nv>$NODE_MAJOR</span><span class=s2>.x nodistro main&#34;</span> <span class=p>|</span> tee /etc/apt/sources.list.d/nodesource.list
</span></span><span class=line><span class=cl>apt-get update
</span></span><span class=line><span class=cl>apt-get install nodejs -y
</span></span></code></pre></div><p>其中 <code>NODE_MAJOR=16</code> 可以自行选择版本：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>NODE_MAJOR</span><span class=o>=</span><span class=m>16</span>
</span></span><span class=line><span class=cl><span class=nv>NODE_MAJOR</span><span class=o>=</span><span class=m>18</span>
</span></span><span class=line><span class=cl><span class=nv>NODE_MAJOR</span><span class=o>=</span><span class=m>20</span>
</span></span><span class=line><span class=cl><span class=nv>NODE_MAJOR</span><span class=o>=</span><span class=m>21</span>
</span></span></code></pre></div><p>安装完成后可通过 <code>node-v</code> 、<code>nmp version</code>、<code>npx -v</code> 检验安装</p><p>卸载：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt-get purge nodejs <span class=o>&amp;&amp;</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>rm -r /etc/apt/sources.list.d/nodesource.list <span class=o>&amp;&amp;</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>rm -r /etc/apt/keyrings/nodesource.gpg
</span></span></code></pre></div><h4 id=二进制安装>二进制安装</h4><p>从 <a class=link href=https://nodejs.org/ target=_blank rel=noopener>Nodejs官网
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>下载二进制包，通过创建软链接至系统用户应用程序目录来使用。</p><p>打开 Nodejs 官网，点击 Downloads 然后右键复制 Linux Binaries (x64) 的下载链接：</p><p><img src=/archives/waline_deploy/1.png width=1152 height=628 srcset="/archives/waline_deploy/1_hu3bc2a4e0dda50b86813c98baa00fba1d_67223_480x0_resize_box_3.png 480w, /archives/waline_deploy/1_hu3bc2a4e0dda50b86813c98baa00fba1d_67223_1024x0_resize_box_3.png 1024w" loading=lazy alt="◎ 二进制文件下载" class=gallery-image data-flex-grow=183 data-flex-basis=440px></p><p>然后回到 SSH 软件，使用 <code>wget</code> 命令，下载到任意位置并进行解压然后删除压缩包；我这里以 <strong>/usr/local/src</strong> 为例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /usr/local/src <span class=c1># 进入目录</span>
</span></span><span class=line><span class=cl>wget https://nodejs.org/dist/v16.18.0/node-v16.18.0-linux-x64.tar.xz <span class=c1># 下载二进制包</span>
</span></span><span class=line><span class=cl>tar -Jxvf node-v16.18.0-linux-x64.tar.xz <span class=c1># 解压</span>
</span></span><span class=line><span class=cl>mv node-v16.18.0-linux-x64 node <span class=c1># 重命名文件夹</span>
</span></span></code></pre></div><p>编辑 <code>~/.bashrc</code> 设置环境变量，加入：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span>/usr/local/src/node/bin:<span class=nv>$PATH</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CPATH</span><span class=o>=</span>/usr/local/src/node/include:<span class=nv>$CPATH</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>LD_LIBRARY_PATH</span><span class=o>=</span>/usr/local/src/node/lib:<span class=nv>$LD_LIBRARY_PATH</span>
</span></span></code></pre></div><p>刷新变量环境：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>source</span> ~/.bashrc
</span></span></code></pre></div><p>完成后可通过 <code>node -v</code> 、 <code>npm version</code> 、 <code>npx -v</code> 进行验证，返回版本号则表示成功。</p><h4 id=源码编译安装>源码编译安装</h4><p>首先安装依赖：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt-get install python3 g++ make python3-pip
</span></span></code></pre></div><p>打开 <a class=link href=https://nodejs.org/ target=_blank rel=noopener>Nodejs官网
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>，复制 <code>Source Code</code> 源码下载地址，接着进行操作：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /usr/local/src
</span></span><span class=line><span class=cl>wget https://nodejs.org/dist/v20.10.0/node-v20.10.0.tar.gz
</span></span><span class=line><span class=cl>tar zxvf node-v20.10.0.tar.gz
</span></span><span class=line><span class=cl>mv node-v20.10.0 node
</span></span><span class=line><span class=cl><span class=nb>cd</span> node
</span></span><span class=line><span class=cl>./configure --prefix<span class=o>=</span>/usr/local/node
</span></span><span class=line><span class=cl>screen -S node
</span></span><span class=line><span class=cl>make <span class=o>&amp;&amp;</span> make install
</span></span></code></pre></div><p>安装完成之后为软件设置环境变量：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim ~/.bashrc
</span></span></code></pre></div><p>在最后添加：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span>/usr/local/node/bin:<span class=nv>$PATH</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CPATH</span><span class=o>=</span>/usr/local/node/include:<span class=nv>$CPATH</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>LD_LIBRARY_PATH</span><span class=o>=</span>/usr/local/node/lib:<span class=nv>$LD_LIBRARY_PATH</span>
</span></span></code></pre></div><p>可以为软件设置个软链接：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ln -s /usr/local/node/bin/node /usr/bin/node
</span></span><span class=line><span class=cl>ln -s /usr/local/node/bin/npm /usr/bin/npm
</span></span><span class=line><span class=cl>ln -s /usr/local/node/bin/npx /usr/bin/npx
</span></span></code></pre></div><p>刷新变量环境：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>source</span> ~/.bashrc
</span></span></code></pre></div><p>源码编译安装比较费时，具体时间视机器配置而定，可酌情选择安装方式。</p><hr><h3 id=安装-waline>安装 Waline</h3><p>按照官方给出的独立部署中直接运行的方案，进入你想要安装的位置，安装好模块后直接运行模块内的 vanilla.js 文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /usr/local/node/lib
</span></span><span class=line><span class=cl>npm install -g @waline/vercel
</span></span></code></pre></div><p>国内服务器请先将 <strong>npm</strong> 设置为国内镜像！！！</p><h4 id=更换镜像>更换镜像</h4><ol><li>临时更换</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>npm --registry https://registry.npmmirror.com install -g @waline/vercel
</span></span></code></pre></div><ol start=2><li>永久更换</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>npm config <span class=nb>set</span> registry https://registry.npmmirror.com
</span></span></code></pre></div><ol start=3><li>还原 npm 镜像</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>npm config <span class=nb>set</span> registry https://registry.npmjs.org/
</span></span></code></pre></div><p>下载完成后，可以试着运行一下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>node node_modules/@waline/vercel/vanilla.js
</span></span></code></pre></div><p>成功的话可以看到提示：</p><p><img src=/archives/waline_deploy/2.png width=600 height=89 srcset="/archives/waline_deploy/2_hu6e1486747a399baf803f1c14f13ca2b8_44276_480x0_resize_box_3.png 480w, /archives/waline_deploy/2_hu6e1486747a399baf803f1c14f13ca2b8_44276_1024x0_resize_box_3.png 1024w" loading=lazy alt="◎ 运行状态" class=gallery-image data-flex-grow=674 data-flex-basis=1617px></p><p>此时你可以通过 <strong>IP:8360</strong> 进行访问；不要着急，按捺下你的小激动，按下 <kbd><kbd>CTRL</kbd>+<kbd>C</kbd></kbd> 关闭，然后跟着我继续进行配置。</p><hr><h3 id=配置数据库>配置数据库</h3><p>到官方文档的 <a class=link href=https://waline.js.org/guide/server/databases.html target=_blank rel=noopener>多数据库服务支持
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>下载我们对应数据库的数据文件，我这里用的 MariaDB(MySQL) 所以下载 <a class=link href=https://github.com/walinejs/waline/blob/main/assets/waline.sql target=_blank rel=noopener>waline.sql
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>然后进行导入数据：</p><blockquote><p><strong>注意</strong>：将源代码直接复制然后自己进行编辑上传，不要直接使用 <code>wget</code> 进行下载。</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mysql -uroot -p <span class=c1># 登陆数据库</span>
</span></span><span class=line><span class=cl>Enter password: <span class=c1># 输入密码</span>
</span></span><span class=line><span class=cl>CREATE DATABASE waline<span class=p>;</span> <span class=c1># 创建 waline 数据库</span>
</span></span><span class=line><span class=cl>USE waline<span class=p>;</span> <span class=c1># 指定数据库</span>
</span></span><span class=line><span class=cl><span class=nb>source</span> /path/waline.sql <span class=c1># 导入文件，/path改为你的路径</span>
</span></span><span class=line><span class=cl>quit <span class=c1># 退出数据库</span>
</span></span></code></pre></div><p>创建用户名，密码并赋予 waline 数据库的权限(可选)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mysql -uroot -p
</span></span><span class=line><span class=cl>Enter password:
</span></span><span class=line><span class=cl>CREATE USER <span class=s1>&#39;waline&#39;</span>@<span class=s1>&#39;%&#39;</span> IDENTIFIED BY <span class=s1>&#39;密码&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>GRANT ALL PRIVILEGES ON waline.* TO <span class=s1>&#39;waline&#39;</span>@<span class=s1>&#39;%&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>flush privileges<span class=p>;</span>
</span></span><span class=line><span class=cl>quit
</span></span></code></pre></div><hr><h3 id=配置-systemd-服务>配置 systemd 服务</h3><p>为了方便 Waline 的正常运行与管理，我使用的是 systemd 服务进行管理，创建文件并进行编辑(拿不准的可以在本地新建文件，编辑之后上传)：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /usr/lib/systemd/system/
</span></span><span class=line><span class=cl>vim waline.service
</span></span></code></pre></div><p>模板如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-systemd data-lang=systemd><span class=line><span class=cl><span class=k>[Unit]</span>
</span></span><span class=line><span class=cl><span class=na>Description</span><span class=o>=</span><span class=s>Waline</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Service]</span>
</span></span><span class=line><span class=cl><span class=na>Type</span><span class=o>=</span><span class=s>simple</span>
</span></span><span class=line><span class=cl><span class=na>ExecStart</span><span class=o>=</span><span class=s>[/path/to/node] [path/to/node_modules]/@waline/vercel/vanilla.js</span>
</span></span><span class=line><span class=cl><span class=na>Restart</span><span class=o>=</span><span class=s>always</span>
</span></span><span class=line><span class=cl><span class=na>Environment</span><span class=o>=</span><span class=s>PATH=/usr/bin:/usr/local/bin</span>
</span></span><span class=line><span class=cl><span class=na>Environment</span><span class=o>=</span><span class=s>NODE_ENV=production</span>
</span></span><span class=line><span class=cl><span class=na>Environment</span><span class=o>=</span><span class=s>MYSQL_DB=数据库名</span>
</span></span><span class=line><span class=cl><span class=na>Environment</span><span class=o>=</span><span class=s>MYSQL_USER=用户名</span>
</span></span><span class=line><span class=cl><span class=na>Environment</span><span class=o>=</span><span class=s>MYSQL_PASSWORD=密码</span>
</span></span><span class=line><span class=cl><span class=na>WorkingDirectory</span><span class=o>=</span><span class=s>[/path/to/node_modules]/@waline/vercel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Install]</span>
</span></span><span class=line><span class=cl><span class=na>WantedBy</span><span class=o>=</span><span class=s>multi-user.target</span>
</span></span></code></pre></div><p>其中，占位符内容如下：</p><pre tabindex=0><code>[/path/to/node]：node 可执行文件绝对路径
[path/to/node_modules]：通过 npm 安装模块位置
</code></pre><p>我的配置如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-systemd data-lang=systemd><span class=line><span class=cl><span class=k>[Unit]</span>
</span></span><span class=line><span class=cl><span class=na>Description</span><span class=o>=</span><span class=s>Waline</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Service]</span>
</span></span><span class=line><span class=cl><span class=na>Type</span><span class=o>=</span><span class=s>simple</span>
</span></span><span class=line><span class=cl><span class=na>ExecStart</span><span class=o>=</span><span class=s>/usr/bin/node /usr/local/node/lib/node_modules/@waline/vercel/vanilla.js</span>
</span></span><span class=line><span class=cl><span class=na>Restart</span><span class=o>=</span><span class=s>always</span>
</span></span><span class=line><span class=cl><span class=na>Environment</span><span class=o>=</span><span class=s>PATH=/usr/bin:/usr/local/bin</span>
</span></span><span class=line><span class=cl><span class=na>Environment</span><span class=o>=</span><span class=s>NODE_ENV=production</span>
</span></span><span class=line><span class=cl><span class=na>Environment</span><span class=o>=</span><span class=s>MYSQL_DB=数据库名</span>
</span></span><span class=line><span class=cl><span class=na>Environment</span><span class=o>=</span><span class=s>MYSQL_USER=用户名</span>
</span></span><span class=line><span class=cl><span class=na>Environment</span><span class=o>=</span><span class=s>MYSQL_PASSWORD=密码</span>
</span></span><span class=line><span class=cl><span class=na>WorkingDirectory</span><span class=o>=</span><span class=s>/usr/local/node/lib/node_modules//@waline/vercel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Install]</span>
</span></span><span class=line><span class=cl><span class=na>WantedBy</span><span class=o>=</span><span class=s>multi-user.target</span>
</span></span></code></pre></div><p>如果你之前按照我的步骤来安装 <strong>Node</strong> 和 <strong>Waline</strong> 那么直接将脚本复制然后修改参数即可，如果你的位置和我不一样，那么就需要将 <strong>ExecStart</strong> 和 <strong>WorkingDirectory</strong> 项中的路径换成你自己的。不确定可以使用命令查一下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>where is node <span class=c1># node 位置</span>
</span></span><span class=line><span class=cl>npm root -g <span class=c1># npm 全局安装位置</span>
</span></span></code></pre></div><p>在 <code>[Service]</code> 项中，你可以通过 <code>Environment</code> 直接添加 Waline 插件的环境变量</p><p>保存/上传完毕后，让 systemd 重新载入单元文件，并启动 Waline ：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl start waline
</span></span></code></pre></div><p>此时再访问 http://IP:8360 ，你就能看到评论页面了。</p><p>一些常用的命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl stop waline  <span class=c1># 停止服务</span>
</span></span><span class=line><span class=cl>systemctl restart waline <span class=c1># 重启服务</span>
</span></span><span class=line><span class=cl>systemctl status waline <span class=c1># 服务状态</span>
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> waline <span class=c1># 添加开机自启动</span>
</span></span></code></pre></div><hr><h3 id=反向代理设置>反向代理设置</h3><p>如果你不想通过 IP:8360 进行访问，那么就需要设置反向代理来通过域名进行访问了这里提供两个配置：</p><h4 id=caddy>Caddy</h4><p>我使用的是 Caddy ， Caddy 反代需要修改 <strong>/etc/caddy/Caddyfile</strong> 文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-caddyfile data-lang=caddyfile><span class=line><span class=cl><span class=gh>domain.com</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>encode</span> <span class=s>gzip</span>
</span></span><span class=line><span class=cl>    <span class=k>reverse_proxy</span> <span class=n>127.0.0.1</span><span class=p>:</span><span class=mi>8360</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>header_up</span> <span class=s>Host</span> <span class=se>{host}</span>
</span></span><span class=line><span class=cl>        <span class=k>header_up</span> <span class=s>X-Real-IP</span> <span class=se>{remote}</span>
</span></span><span class=line><span class=cl>        <span class=k>header_up</span> <span class=s>X-Forwarded-For</span> <span class=se>{remote}</span>
</span></span><span class=line><span class=cl>        <span class=k>header_up</span> <span class=s>X-Forwarded-Proto</span> <span class=s>https</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>file_server</span>
</span></span><span class=line><span class=cl>    <span class=k>tls</span> <span class=s>user@email.com</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=nginx>Nginx</h4><p>Nginx 反向代理如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kn>proxy_pass</span> <span class=s>http://127.0.0.1:8360</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kn>proxy_set_header</span> <span class=s>Host</span> <span class=nv>$host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kn>proxy_set_header</span> <span class=s>X-Real-IP</span> <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kn>proxy_set_header</span> <span class=s>X-Forwarded-For</span> <span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kn>proxy_set_header</span> <span class=s>X-Forwarded-Proto</span> <span class=nv>$scheme</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kn>proxy_set_header</span> <span class=s>REMOTE-HOST</span> <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kn>add_header</span> <span class=s>X-Cache</span> <span class=nv>$upstream_cache_status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1># cache
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kn>add_header</span> <span class=s>Cache-Control</span> <span class=s>no-cache</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kn>expires</span> <span class=s>12h</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><hr><h2 id=总结>总结</h2><p>以上就是我通过 Caddy+MariaDB 独立部署 Waline 的过程，希望能给大家带来帮助。后期如果需要设置邮件通知等功能可以在 waline.service 文件中的 <strong>[Service]</strong> 项下直接添加 Environment= 然后根据官方给出的环境变量进行设置即可。</p><p>若 Waline 后台发现有更新提示，可通过 <code>npm</code> 对 Waline 进行更新：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>npm update @waline/vercel
</span></span></code></pre></div><h3 id=参考资料>参考资料</h3><ol><li><p><a class=link href=https://waline.js.org target=_blank rel=noopener>Waline 官方文档
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p></li><li><p><a class=link href=https://github.com/nodesource/distributions/blob/master/README.md target=_blank rel=noopener>NodeSource - Node.js 官方二进制发行版
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p></li><li><p><a class=link href=https://github.com/nodejs/help/wiki/Installation target=_blank rel=noopener>通过二进制文件安装 Node.js
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p></li><li><p><a class=link href=https://www.ruanyifeng.com/blog/2016/03/node-systemd-tutorial.html target=_blank rel=noopener>Node 应用的 Systemd 启动
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p></li></ol></section><footer class=article-footer><section class=article-tags><a href=/tags/hugo/>Hugo</a>
<a href=/tags/blog/>Blog</a>
<a href=/tags/caddy/>Caddy</a>
<a href=/tags/mysql/>MySQL</a>
<a href=/tags/mariadb/>MariaDB</a>
<a href=/tags/waline/>Waline</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 Oct 23, 2022</span></section></footer></article><footer class=site-footer><section class=powerby>&copy;
2024 <b>Kitin</b>&nbsp;&#183;&nbsp;Built with <b><a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></b> &
        <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.23.0>Stack</a></b> Theme</section><br><section class=copyright><img src=/img/pc.svg alt=PC width=14px height=14px> <a href="https://beian.mps.gov.cn/#/query/webSearch?code=36010302000981" rel=noreferrer target=_blank>赣公网安备36010302000981</a><br><img src=/img/icp.svg alt=ICP width=14px height=14px> <a href=https://beian.miit.gov.cn/ target=_blank>赣ICP备2024024305号-1</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script src=https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/js/nprogress.min.js integrity=sha384-bHDlAEUFxsRI7JfULv3DTpL2IXbbgn4JHQJibgo5iiXSK6Iu8muwqHANhun74Cqg crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/css/nprogress.css integrity=sha384-KJyhr2syt5+4M9Pz5dipCvTrtvOmLk/olWVdfhAp858UCa64Ia5GFpTN7+G4BWpE crossorigin=anonymous><script>NProgress.start(),document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&NProgress.inc(.8),document.readyState==="complete"&&NProgress.done()})</script></body></html>